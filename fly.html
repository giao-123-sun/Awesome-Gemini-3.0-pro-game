<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Web Minecraft: 鞘翅飞行测试版</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Minecraft', sans-serif; }
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            pointer-events: none;
            font-family: monospace;
        }
        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }
        .key { color: #ffff00; font-weight: bold; }
    </style>
</head>
<body>
    <div id="crosshair"></div>
    <div id="ui">
        <h3>操作指南</h3>
        <p>[点击屏幕] 开始游戏 / 锁定鼠标</p>
        <p><span class="key">W, A, S, D</span> 移动</p>
        <p><span class="key">SPACE</span> 跳跃</p>
        <p><span class="key">CTRL</span> 按住疾跑</p>
        <p><span class="key">SHIFT</span> 按住潜行</p>
        <hr>
        <p><span class="key">F 键</span> 切换鞘翅飞行模式 (Elytra)</p>
        <p><span class="key">鼠标右键</span> 使用烟花加速 (需在飞行中)</p>
        <p>状态: <span id="status" style="color:lightgreen">地面行走</span></p>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // --- 1. 场景初始化 ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB); // 天空蓝
        scene.fog = new THREE.Fog(0x87CEEB, 0, 750);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // --- 2. 灯光 ---
        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444);
        hemiLight.position.set(0, 200, 0);
        scene.add(hemiLight);

        const dirLight = new THREE.DirectionalLight(0xffffff);
        dirLight.position.set(0, 200, 100);
        scene.add(dirLight);

        // --- 3. 世界生成 (简单的方块地面和柱子) ---
        const geometry = new THREE.BoxGeometry(1, 1, 1);
        const grassMaterial = new THREE.MeshStandardMaterial({ color: 0x55AA55 }); // 绿色
        const stoneMaterial = new THREE.MeshStandardMaterial({ color: 0x888888 }); // 灰色

        // 生成地面
        const floorSize = 100;
        const floorGeometry = new THREE.PlaneGeometry(200, 200);
        const floorMaterial = new THREE.MeshStandardMaterial({ color: 0x338833, side: THREE.DoubleSide });
        const floor = new THREE.Mesh(floorGeometry, floorMaterial);
        floor.rotation.x = - Math.PI / 2;
        scene.add(floor);

        // 生成一些随机柱子让你飞跃
        for (let i = 0; i < 100; i++) {
            const material = Math.random() > 0.5 ? grassMaterial : stoneMaterial;
            const mesh = new THREE.Mesh(geometry, material);
            mesh.position.x = (Math.random() - 0.5) * 100;
            mesh.position.z = (Math.random() - 0.5) * 100;
            mesh.position.y = 0.5 + Math.random() * 5; // 高度
            mesh.scale.y = mesh.position.y * 2; 
            scene.add(mesh);
        }

        // --- 4. 玩家控制逻辑 ---
        const controls = new PointerLockControls(camera, document.body);
        
        const instructions = document.getElementById('ui');
        const statusText = document.getElementById('status');

        document.body.addEventListener('click', () => {
            controls.lock();
        });

        // 移动状态
        let moveForward = false;
        let moveBackward = false;
        let moveLeft = false;
        let moveRight = false;
        let canJump = false;
        let isSprinting = false;
        let isSneaking = false;

        // 物理变量
        let velocity = new THREE.Vector3();
        let direction = new THREE.Vector3();
        let prevTime = performance.now();
        
        // 鞘翅飞行变量
        let isFlying = false;
        let flySpeed = 0; // 额外的飞行速度

        const onKeyDown = (event) => {
            switch (event.code) {
                case 'ArrowUp': case 'KeyW': moveForward = true; break;
                case 'ArrowLeft': case 'KeyA': moveLeft = true; break;
                case 'ArrowDown': case 'KeyS': moveBackward = true; break;
                case 'ArrowRight': case 'KeyD': moveRight = true; break;
                case 'Space': 
                    if (canJump && !isFlying) velocity.y += 350; 
                    break;
                case 'ControlLeft': isSprinting = true; break;
                case 'ShiftLeft': isSneaking = true; break;
                case 'KeyF': // 切换鞘翅模式
                    isFlying = !isFlying;
                    if(isFlying) {
                        velocity.y = 100; // 给一点初始高度跳跃
                        statusText.innerText = "鞘翅滑翔中 (按右键使用烟花)";
                        statusText.style.color = "cyan";
                    } else {
                        statusText.innerText = "地面行走";
                        statusText.style.color = "lightgreen";
                    }
                    break;
            }
        };

        const onKeyUp = (event) => {
            switch (event.code) {
                case 'ArrowUp': case 'KeyW': moveForward = false; break;
                case 'ArrowLeft': case 'KeyA': moveLeft = false; break;
                case 'ArrowDown': case 'KeyS': moveBackward = false; break;
                case 'ArrowRight': case 'KeyD': moveRight = false; break;
                case 'ControlLeft': isSprinting = false; break;
                case 'ShiftLeft': isSneaking = false; break;
            }
        };

        // 烟花加速逻辑
        document.addEventListener('mousedown', (event) => {
            if (event.button === 2 && isFlying && controls.isLocked) { // 右键
                // 模拟烟花加速：向镜头朝向猛冲
                const boost = 800; // 加速力度
                // 获取当前摄像机朝向
                const camDir = new THREE.Vector3();
                camera.getWorldDirection(camDir);
                
                // 将速度施加到当前方向
                velocity.x += camDir.x * boost;
                velocity.z += camDir.z * boost;
                velocity.y += camDir.y * boost; // 允许向上冲刺
                
                // 视觉反馈（简单的控制台输出，实际可加粒子效果）
                console.log("Firework Boost!");
            }
        });

        document.addEventListener('keydown', onKeyDown);
        document.addEventListener('keyup', onKeyUp);

        // --- 5. 游戏循环 (核心物理) ---
        const animate = () => {
            requestAnimationFrame(animate);

            const time = performance.now();
            if (controls.isLocked === true) {
                const delta = (time - prevTime) / 1000;

                // 摩擦力/阻力
                velocity.x -= velocity.x * 5.0 * delta;
                velocity.z -= velocity.z * 5.0 * delta;

                // 只有在非飞行模式下才受到强重力
                if (!isFlying) {
                    velocity.y -= 9.8 * 100.0 * delta; // 重力: 100.0 = mass
                } else {
                    // 飞行模式重力减弱 (滑翔感)
                    velocity.y -= 9.8 * 20.0 * delta; 
                    // 空气阻力较小，保持动量
                    velocity.x -= velocity.x * 0.5 * delta; 
                    velocity.z -= velocity.z * 0.5 * delta;
                }

                direction.z = Number(moveForward) - Number(moveBackward);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize(); // 保证各个方向速度一致

                // --- 速度计算 ---
                let baseSpeed = 400.0;
                if (isSprinting) baseSpeed = 800.0; // 疾跑
                if (isSneaking) baseSpeed = 100.0;  // 潜行

                // 地面移动逻辑
                if (moveForward || moveBackward) velocity.z -= direction.z * baseSpeed * delta;
                if (moveLeft || moveRight) velocity.x -= direction.x * baseSpeed * delta;

                controls.moveRight(-velocity.x * delta);
                controls.moveForward(-velocity.z * delta);

                // 高度控制 (潜行降低视线)
                if (isSneaking && !isFlying) {
                    camera.position.y = Math.max(camera.position.y, 0.5); // 蹲下
                }

                controls.getObject().position.y += (velocity.y * delta); // 处理Y轴移动

                // 地面碰撞检测
                if (controls.getObject().position.y < 2.0) { // 假设地面高度
                    velocity.y = 0;
                    controls.getObject().position.y = 2.0;
                    canJump = true;
                    
                    // 如果落地，自动取消飞行模式
                    if(isFlying) {
                        isFlying = false;
                        statusText.innerText = "地面行走";
                        statusText.style.color = "lightgreen";
                    }
                } else {
                    canJump = false;
                }

                // 潜行防止掉落 (简单模拟: 如果在边缘且潜行，这里简化为减速)
                // 真实Minecraft的边缘检测很复杂，这里仅用速度限制模拟小心翼翼的感觉
            }

            prevTime = time;
            renderer.render(scene, camera);
        };

        animate();

        // 窗口大小调整
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>